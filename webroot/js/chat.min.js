xetaChat={actualWindowTitle:$(document).attr("title"),lastRefresh:Math.round((new Date).getTime()/1e3),notice:null,lastMessage:{id:null,time:null,text:null},settings:{autoScroll:1,maxMessages:25,maxRetrying:5,floodRule:3e3,spamRule:95,messageMaxLength:400,smiliesAdded:!1,smiliesShowed:!1,locale:"en",refreshTime:null,urlRefresh:null,urlDeleteMessage:null,urlGetNotice:null},domIDs:{chatboxContent:"chatboxContent",inputMessage:"chatboxMessage",buttonSend:"chatboxSend",userCounter:"usersCount",notice:"chatboxNotice",smiliesBox:"smiliesBox",usersOnline:"chatboxOnline",deleteMessage:"chatboxDeleteMessage"},dom:null,user:{id:null,groupId:null,groupName:null,isConnected:null},lang:null,smileys:{crying:{replace:'<i class="xeta-smiley icon-crying" data-name="crying" data-toggle="tooltip" title="cry"></i>',smiley:":cry:"},frustrated:{replace:'<i class="xeta-smiley icon-frustrated" data-name="frustrated" data-toggle="tooltip" title="frustrated"></i>',smiley:":frustrated:"},sleepy:{replace:'<i class="xeta-smiley icon-sleepy" data-name="sleepy" data-toggle="tooltip" title="sleepy"></i>',smiley:":sleepy:"},hipster:{replace:'<i class="xeta-smiley icon-hipster" data-name="hipster" data-toggle="tooltip" title="hipster"></i>',smiley:":hipster:"},heartbroken:{replace:'<i class="xeta-smiley icon-heart-broken text-danger" data-name="heartbroken" data-toggle="tooltip" title="heartbroken"></i>',smiley:":heartbroken:"},heart:{replace:'<i class="xeta-smiley icon-heart text-danger" data-name="heart" data-toggle="tooltip" title="heart"></i>',smiley:":heart:"},boy:{replace:'<i class="xeta-smiley icon-boy text-info" data-name="boy" data-toggle="tooltip" title="boy"></i>',smiley:":boy:"},girl:{replace:'<i class="xeta-smiley icon-girl text-pink" data-name="girl" data-toggle="tooltip" title="girl"></i>',smiley:":girl:"},cool:{replace:'<i class="xeta-smiley icon-cool" data-name="cool" data-toggle="tooltip" title="cool"></i>',smiley:":cool:"},evil:{replace:'<i class="xeta-smiley icon-evil" data-name="evil" data-toggle="tooltip" title="evil"></i>',smiley:":evil:"},un:{replace:'<i class="xeta-smiley icon-un" data-name="un" data-toggle="tooltip" title="un"></i>',smiley:":un:"},ghost:{replace:'<i class="xeta-smiley icon-ghost" data-name="ghost" data-toggle="tooltip" title="ghost"></i>',smiley:":ghost:"},pacman:{replace:'<i class="xeta-smiley icon-pacman" data-name="pacman" data-toggle="tooltip" title="pacman"></i>',smiley:":pacman:"},medal:{replace:'<i class="xeta-smiley icon-medal" data-name="medal" data-toggle="tooltip" title="medal"></i>',smiley:":medal:"},medal2:{replace:'<i class="xeta-smiley icon-medal2" data-name="medal2" data-toggle="tooltip" title="medal2"></i>',smiley:":medal2:"},superman:{replace:'<i class="xeta-smiley icon-superman" data-name="superman" data-toggle="tooltip" title="superman"></i>',smiley:":superman:"},pokeball:{replace:'<i class="xeta-smiley icon-pokeball" data-name="pokeball" data-toggle="tooltip" title="pokeball"></i>',smiley:":pokeball:"},toad:{replace:'<i class="xeta-smiley icon-toad" data-name="toad" data-toggle="tooltip" title="toad"></i>',smiley:":toad:"},happy:{replace:'<i class="xeta-smiley icon-happy" data-name="happy" data-toggle="tooltip" title=":D"></i>',smiley:":D"},baffled:{replace:'<i class="xeta-smiley icon-baffled" data-name="baffled" data-toggle="tooltip" title="o.o"></i>',smiley:"o.o"},smile:{replace:'<i class="xeta-smiley icon-smile" data-name="smile" data-toggle="tooltip" title=":)"></i>',smiley:":)"},sad:{replace:'<i class="xeta-smiley icon-sad" data-name="sad" data-toggle="tooltip" title=":("></i>',smiley:":("},tongue:{replace:'<i class="xeta-smiley icon-tongue" data-name="tongue" data-toggle="tooltip" title=":P"></i>',smiley:":P"},wink:{replace:'<i class="xeta-smiley icon-wink" data-name="wink" data-toggle="tooltip" title=";)"></i>',smiley:";)"},grin:{replace:'<i class="xeta-smiley icon-grin" data-name="grin" data-toggle="tooltip" title="xD"></i>',smiley:"xD"},confused:{replace:'<i class="xeta-smiley icon-confused" data-name="confused" data-toggle="tooltip" title=":S"></i>',smiley:":S"},angry:{replace:'<i class="xeta-smiley icon-angry" data-name="angry" data-toggle="tooltip" title=":@"></i>',smiley:":@"},shocked:{replace:'<i class="xeta-smiley icon-shocked" data-name="shocked" data-toggle="tooltip" title=":O"></i>',smiley:":O"},neutral:{replace:'<i class="xeta-smiley icon-neutral" data-name="neutral" data-toggle="tooltip" title=":|"></i>',smiley:":|"}},init:function(t,e){this.lang=e,this.settings=this._mergeObjects(this.settings,t),this._initializeDocumentNodes(),this._updateChat()},_initializeDocumentNodes:function(){this.dom={};for(var t in this.domIDs)this.dom[t]=document.getElementById(this.domIDs[t])},_updateChat:function(t){t="undefined"!=typeof t?t:0,$.ajax({type:"GET",url:this.settings.urlRefresh,dataType:"xml",data:{lastMessageId:null!==this.lastMessage.id?this.lastMessage.id:0},success:function(t){xetaChat._handleXML(t)},error:function(){t++}}),(0===t||0!==t&&t<this.settings.maxRetrying)&&setTimeout(function(){xetaChat._updateChat(t)},this.settings.refreshTime)},deleteMessage:function(t){return $.ajax({type:"POST",url:this.settings.urlDeleteMessage,data:{id:t},dataType:"json",success:function(e){e.error===!1?(xetaChat._getMessageNode(t)&&$("#chatboxMessage-"+t).remove(),xetaChat._notify("primary",e.message)):xetaChat._notify("danger",e.message)},error:function(){xetaChat._notify("danger",xetaChat.lang.errorToDeleteMessage)}}),!0},addSmiliesToBox:function(){if(this.settings.smiliesAdded===!1){var t="";for(var e in this.smileys)t+=this.smileys[e].replace;$(this.dom.smiliesBox).html(t),$(this.dom.smiliesBox).fadeIn("slow"),this.settings.smiliesAdded=!0,this.settings.smiliesShowed=!0}else this.settings.smiliesShowed===!0?($(this.dom.smiliesBox).fadeOut("slow"),this.settings.smiliesShowed=!1):($(this.dom.smiliesBox).fadeIn("slow"),this.settings.smiliesShowed=!0)},sendShout:function(){if(this._disableInputs(!0),this.user.isConnected===!1)return void this._notify("danger",this.lang.userNotConnected);var t=$(this.dom.inputMessage).val().trim();return this._handleShoutRules(t)!==!1?($.ajax({type:"POST",url:$(this.dom.buttonSend).attr("data-url"),dataType:"json",data:{message:t},success:function(e){e.error!==!1||"undefined"!=typeof e.hasCmd&&e.hasCmd!==!1||"undefined"!=typeof e.message?"undefined"!=typeof e.hasCmd&&e.hasCmd===!0&&e.error===!1?xetaChat._handleCommands(e):e.error===!1&&e.hasCmd===!1&&"undefined"!=typeof e.message?xetaChat._notify("danger",e.message):xetaChat._notify("danger",e.message):($(xetaChat.dom.inputMessage).val(""),xetaChat.lastMessage.text=t,xetaChat.lastMessage.time=(new Date).getTime()),xetaChat._disableInputs(!1),$(xetaChat.dom.inputMessage).focus()},error:function(){xetaChat._notify("danger",xetaChat.lang.errorToShout),xetaChat._disableInputs(!1)}}),!0):void 0},_addMessageToChatList:function(t,e,a,s,i,o,n,l){this._getMessageNode(n)||$(this.dom.chatboxContent).prepend($("<li>").attr({id:"chatboxMessage-"+n,"data-userid":e,"data-messageid":n}).append($("<div>").addClass("dropdown actions").append($("<a>").addClass("popupControl").attr({href:"#","data-toggle":"dropdown","aria-expanded":"false","aria-haspopup":"true"}).append($("<span>").addClass("caret"))).append($("<ul>").addClass("dropdown-menu").attr({role:"menu"}).append($("<li>").append($("<a>").attr({id:this.domIDs.deleteMessage,href:"#",role:"menuitem","data-id":n}).text("Delete"))))).append($("<span>").addClass("dateTime").text(" - ").prepend($("<time>").addClass("DateTime").attr("data-livestamp",t).text(this.lang.AFewSecondsAgo))).append($("<span>").append($("<span>").addClass("chatboxTag").attr({title:"Reply","data-toggle":"tooltip","data-placement":"left",onclick:"var member = $(this).parent().children('a.username').text(); $('input#chatboxMessage').val($('#chatboxMessage').focus().val() + '@' + member.trim() + ' ');"}).append($("<i>").addClass("fa fa-reply"))).append($("<a>").addClass("username").attr({style:s,href:i}).text(" "+a)).append(": ").append($("<div>").addClass("chatboxMessageText").html(this._formatText(l)))))},_handleXML:function(t){this._handleInfos(t),this._handleOnlineUsers(t),this._handleChatMessages(t)},_handleInfos:function(t){$(t).find("info").each(function(e){var a=$(t).find("info")[e].firstElementChild.nodeName,s=$(t).find("info")[e].firstElementChild.textContent;xetaChat._handleInfo(a,s)})},_handleInfo:function(t,e){switch(t){case"usersCounter":this._updateUsersCounter(e);break;case"notice":e!==this.notice&&(this._updateNotice(e),this.notice=e);break;case"isConnected":var a=this._getBool(e);a===!1&&this._disableInputs(!0),this.user.isConnected=a}},_handleOnlineUsers:function(t){if(t.getElementsByTagName("user")[0].childNodes.length){$(".panel-chat-online").is(":visible")===!1&&$(".panel-chat-online").show(),$(this.dom.usersOnline).html("");var e=$("id",$(t).find("user")[$(t).find("user").length-1]).text();$(t).find("user").each(function(){xetaChat._handleUser($("id",this).text(),$("user_id",this).text(),$("username",this).text(),$("group_id",this).text(),$("css",this).text(),$("is_banned",this).text(),$("created",this).text(),$("link",this).text(),e)})}else $(".panel-chat-online").hide()},_handleUser:function(t,e,a,s,i,o,n,l,r){if(!this._getUserNode(e)){var d=" ";r!=t&&(d=", "),$(this.dom.usersOnline).append($("<li>").attr({id:"chatboxUser-"+e}).append($("<a>").addClass("username").attr({style:i,href:l}).text(a)).append(d))}},_handleChatMessages:function(t){t.getElementsByTagName("message").length&&($(t).find("message").each(function(){xetaChat._addMessageToChatList($("created",this).text(),$("user_id",this).text(),$("username",this).text(),$("css",this).text(),$("link",this).text(),$("group_id",this).text(),$("id",this).text(),$("text",this).text(),$("command",this).text())}),this._updateChatlistView(),this.lastMessage.id=$("id",$(t).find("message")[$(t).find("message").length-1]).text())},_updateChatlistView:function(){if(this.dom.chatboxContent.childNodes&&this.settings.maxMessages)for(;this.dom.chatboxContent.childNodes.length>this.settings.maxMessages;)this.dom.chatboxContent.removeChild(this.dom.chatboxContent.lastChild);this.settings.autoScroll&&(this.dom.chatboxContent.scrollTop=this.dom.chatboxContent.scrollHeight)},_handleCommands:function(t){switch(t.command){case"prune":this._handleCommandPrune(t),$(this.dom.inputMessage).val("");break;case"ban":$(this.dom.inputMessage).val("");break;case"unban":$(this.dom.inputMessage).val("")}},_handleCommandPrune:function(t){if(this.dom.chatboxContent.childNodes&&t.lastMessageId)for(;xetaChat.dom.chatboxContent.childNodes[0]&&xetaChat.dom.chatboxContent.childNodes[0].id!="chatboxMessage-"+t.lastMessageId;)this.dom.chatboxContent.removeChild(this.dom.chatboxContent.lastChild)},_handleShoutRules:function(t){if(null!==this.lastMessage.time&&this.lastMessage.time+this.settings.floodRule>(new Date).getTime())return this._notify("danger",this.lang.floodRule),this._disableInputs(!1),!1;var e=this._similarText(t,this.lastMessage.text,1);return e>this.settings.spamRule?(this._notify("danger",this.lang.spamRule),this._disableInputs(!1),!1):0===t.length?(this._notify("danger",this.lang.emptyMessage),this._disableInputs(!1),!1):t.length>this.settings.messageMaxLength?(this._notify("danger",this.lang.messageMaxLength),this._disableInputs(!1),!1):!0},_disableInputs:function(t){t===!0?($(this.dom.inputMessage).attr("disabled",!0).addClass("disabled"),$(this.dom.buttonSend).attr("disabled",!0).addClass("disabled")):($(this.dom.inputMessage).removeAttr("disabled").removeClass("disabled"),$(this.dom.buttonSend).removeAttr("disabled").removeClass("disabled"))},_similarText:function(t,e,a){if(null===t||null===e||"undefined"==typeof t||"undefined"==typeof e)return 0;t+="",e+="";var s,i,o,n,l=0,r=0,d=0,c=t.length,h=e.length;for(d=0,s=0;c>s;s++)for(i=0;h>i;i++){for(o=0;c>s+o&&h>i+o&&t.charAt(s+o)===e.charAt(i+o);o++);o>d&&(d=o,l=s,r=i)}return n=d,n&&(l&&r&&(n+=this._similarText(t.substr(0,l),e.substr(0,r))),c>l+d&&h>r+d&&(n+=this._similarText(t.substr(l+d,c-l-d),e.substr(r+d,h-r-d)))),a?200*n/(c+h):n},_isArray:function(t){return"[object Array]"==Object.prototype.toString.call(t)},_mergeObjects:function(t,e){var a,s,i,o;if("undefined"==typeof e)return e;if("undefined"==typeof t)return t;for(var n in e)if(a=e[n],"object"==typeof a&&null!==a)if(xetaChat._isArray(a)&&a.length)if("object"!=typeof a[0])if(s=t[n]){i={};for(var l=0,r=s.length;r>l;l++)i[s[l]]=!0;for(var d=0,c=a.length;c>d;d++)a[d]in i||s.push(a[d])}else t[n]=a;else{o={},s=t[n];for(var h=0,m=s.length;m>h;h++)o[s[h].id]=s[h];for(var u=0,g=a.length;g>u;u++)a[u].id in o?xetaChat._mergeObjects(o[a[u].id],a[u]):s.push(a[u])}else xetaChat._mergeObjects(t[n],a);else t[n]=a;return t},_notify:function(t,e){$(".top-right").notify({message:{text:e},type:t}).show()},_getBool:function(t){return!!JSON.parse(String(t).toLowerCase())},_getMessageNode:function(t){return null===t?null:document.getElementById("chatboxMessage-"+t)},_getUserNode:function(t){return null===t?null:document.getElementById("chatboxUser-"+t)},_updateUsersCounter:function(t){$(this.dom.userCounter).text(t)},_updateNotice:function(t){$(this.dom.notice).html(this._replaceSmiley(t))},_formatText:function(t){return this._replaceSmiley(this._escapeHTML(t))},_replaceSmiley:function(t){var e=this.smileys;for(var a in e){var s=new RegExp(this._escapeRegExp(e[a].smiley),"gi");t=t.replace(s,e[a].replace)}return t},_escapeHTML:function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\'/g,"&#39;")},_escapeRegExp:function(t){return t.replace(/[-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}},$(document).ready(function(){$("#noticeForm").submit(function(t){return t.preventDefault(),t.stopPropagation(),$.ajax({type:"POST",url:$(this).attr("action"),dataType:"json",data:{notice:CKEDITOR.instances.noticeBox.getData()},success:function(t){$("#noticeModal").modal("hide"),1==t.error&&xetaChat._notify("danger",t.message)},error:function(){xetaChat._notify("danger",xetaChat.lang.errorToEditTheNotice)}}),!1}),$("#noticeModal").on("hide.bs.modal",function(){CKEDITOR.instances.noticeBox.destroy()}),$("#chatboxMessage").keypress(function(t){return t.which&&13==t.which||t.keyCode&&13==t.keyCode?(xetaChat.sendShout(),!1):void 0}),$("#chatboxSend").on("click",function(t){return t.preventDefault(),t.stopPropagation(),xetaChat.sendShout(),!1}),$("#chatboxSmiliePicker").on("click",function(){xetaChat.addSmiliesToBox()}),$("#smiliesBox").on("click",".xeta-smiley",function(){var t=$(this).attr("data-name");return $(xetaChat.dom.inputMessage).insertAroundCaret(" "+xetaChat.smileys[t].smiley,""),!1}),$("#chatboxContent").on("click","#"+xetaChat.domIDs.deleteMessage,function(){var t=$(this).attr("data-id");return xetaChat.deleteMessage(t),!1})}),jQuery.fn.extend({insertAroundCaret:function(t,e){return this.each(function(){if(document.selection)this.focus(),sel=document.selection.createRange(),sel.text=t+sel.text+e,this.focus();else if(this.selectionStart||"0"==this.selectionStart){var a=this.selectionStart,s=this.selectionEnd,i=this.scrollTop;this.value=this.value.substring(0,a)+t+this.value.substring(a,s)+e+this.value.substring(s,this.value.length),this.focus(),this.selectionStart=a+t.length+e.length+(s-a),this.selectionEnd=a+t.length+e.length+(s-a),this.scrollTop=i}else this.value+=t+e,this.focus()})}});